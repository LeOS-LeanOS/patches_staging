From bc4925f6bf3100e7ae3a39b70ef91c4d2355715e Mon Sep 17 00:00:00 2001
From: Christopher A. Williamson <contact@chrisaw.io>
Date: Thu, 10 Apr 2025 22:48:35 +0100
Subject: [PATCH 1/9] feat: Add switch to disable securize

---
 app/src/main/java/me/phh/treble/app/Misc.kt   |  4 +++
 .../java/me/phh/treble/app/MiscSettings.kt    | 33 -------------------
 app/src/main/res/values/strings.xml           |  1 -
 app/src/main/res/xml/pref_misc.xml            |  7 ++--
 4 files changed, 9 insertions(+), 36 deletions(-)

diff --git a/app/src/main/java/me/phh/treble/app/Misc.kt b/app/src/main/java/me/phh/treble/app/Misc.kt
index 9183f32..05efb66 100644
--- a/app/src/main/java/me/phh/treble/app/Misc.kt
+++ b/app/src/main/java/me/phh/treble/app/Misc.kt
@@ -340,6 +340,10 @@ object Misc: EntryStartup {
                 val value = sp.getString(key, "0")
                 SystemProperties.set("persist.sys.bt.esco_transport_unit_size", value)
             }
+            MiscSettings.securize -> {
+                val value = sp.getBoolean(key, false)
+                SystemProperties.set("persist.sys.phh.securize", if (value) "1" else "0")
+            }
             MiscSettings.secureAdb -> {
                 val value = sp.getBoolean(key, false)
                 SystemProperties.set("persist.sys.phh.adb_secure", if (value) "1" else "0")
diff --git a/app/src/main/java/me/phh/treble/app/MiscSettings.kt b/app/src/main/java/me/phh/treble/app/MiscSettings.kt
index e04d585..5207299 100644
--- a/app/src/main/java/me/phh/treble/app/MiscSettings.kt
+++ b/app/src/main/java/me/phh/treble/app/MiscSettings.kt
@@ -60,39 +60,6 @@ class MiscSettingsFragment : SettingsFragment() {
     override fun onCreatePreferences(savedInstanceState: Bundle?, rootKey: String?) {
         super.onCreatePreferences(savedInstanceState, rootKey)

-        val securizePref = findPreference<Preference>(MiscSettings.securize)
-        securizePref!!.setOnPreferenceClickListener {
-                val builder = AlertDialog.Builder( this.getActivity() )
-                builder.setTitle(getString(R.string.remove_root))
-                builder.setMessage(getString(R.string.continue_question))
-
-                builder.setPositiveButton(android.R.string.yes) { dialog, which ->
-
-                var cmds = listOf(
-                    arrayOf("/sbin/su", "-c", "/system/bin/phh-securize.sh"),
-                    arrayOf("/system/xbin/su", "-c", "/system/bin/phh-securize.sh"),
-                    arrayOf("/system/xbin/phh-su", "-c", "/system/bin/phh-securize.sh"),
-                    arrayOf("/sbin/su", "0", "/system/bin/phh-securize.sh"),
-                    arrayOf("/system/xbin/su", "0", "/system/bin/phh-securize.sh"),
-                    arrayOf("/system/xbin/phh-su", "0", "/system/bin/phh-securize.sh")
-                )
-                for (cmd in cmds) {
-                    try {
-                        Runtime.getRuntime().exec(cmd).waitFor()
-                        break
-                    } catch (t: Throwable) {
-                        Log.d("PHH", "Failed to exec \"" + cmd.joinToString(separator = " ") + "\", skipping")
-                    }
-                }
-            }
-
-            builder.setNegativeButton(android.R.string.no) { dialog, which ->
-            }
-
-            builder.show()
-            return@setOnPreferenceClickListener true
-        }
-
         val removeTelephonyPref = findPreference<Preference>(MiscSettings.removeTelephony)
         removeTelephonyPref!!.setOnPreferenceClickListener {

diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 875a08f..4d264a9 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -4,7 +4,6 @@
     <string name="title_activity_top_level">TrebleDroid Settings</string>
     <string name="desc_activity_top_level">Device specific settings</string>
     <string name="remove_telephony_subsystem">Remove Telephony Subsystem</string>
-    <string name="remove_root">Remove Root</string>
     <string name="continue_question">Continue?</string>
     <string name="title_activity_updater">Updater</string>
     <string name="update_not_found_title">Your system is up to date</string>
diff --git a/app/src/main/res/xml/pref_misc.xml b/app/src/main/res/xml/pref_misc.xml
index 3839ed1..44bbc84 100644
--- a/app/src/main/res/xml/pref_misc.xml
+++ b/app/src/main/res/xml/pref_misc.xml
@@ -208,8 +208,11 @@
             android:entryValues="@array/pref_misc_fod_color_values"
             android:key="key_misc_fod_color"
             android:title="Under-display fp color" />
-        <Preference android:title="Securize"
-            android:key="key_misc_securize" />
+        <SwitchPreference
+            android:defaultValue="true"
+            android:key="key_misc_securize"
+            android:title="Enable Securize"
+            android:summary="Disabling may fix play services on uncertified devices" />
         <SwitchPreference
             android:defaultValue="false"
             android:key="key_misc_secure_adb"
--
2.47.2
